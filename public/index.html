<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Coinmate Bot | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --text-muted: #94a3b8;
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --border: #334155;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 100px; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; border: 1px solid var(--border); margin-bottom: 20px; position: relative; }
        .strategies-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .strategy-card { border-radius: 12px; border: 1px solid var(--border); border-top: 6px solid var(--strat-color); padding: 25px; background: var(--card-bg); position: relative; }
        
        .btn-delete { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; font-size: 1.5rem; opacity: 0.5; transition: 0.2s; padding: 5px; }
        .btn-delete:hover { opacity: 1; color: var(--danger); transform: scale(1.1); }
        
        .row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }
        input[type="number"], input[type="text"], input[type="password"], select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--border); border-radius: 8px; color: white; font-family: inherit; box-sizing: border-box; }
        input:disabled, select:disabled { opacity: 0.5; cursor: not-allowed; }
        label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; display: block; }
        .form-text { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; line-height: 1.4; }
        
        /* Radio Styles */
        .radio-group { display: flex; flex-direction: column; gap: 10px; }
        .radio-item { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        input[type="radio"] { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; margin: 0; }

        .actions-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 20px; z-index: 100; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; color: white; }
    </style>
</head>
<body>
<div class="container">
    <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="color:var(--primary); margin:0;">ğŸš€ Coinmate DCA Bot</h2>
        <div id="portfolio-mini-stats" style="font-weight:600;"></div>
    </div>

    <div class="card collapsible" id="api-card">
        <div class="card-header" onclick="document.getElementById('api-content').style.display = document.getElementById('api-content').style.display === 'none' ? 'block' : 'none'" style="cursor:pointer">
            <h3 style="margin:0">ğŸ” API KlÃ­Äe</h3>
        </div>
        <div id="api-content" style="display:none; margin-top:20px;">
            <div class="row">
                <div class="col"><label>Client ID</label><input type="text" id="clientId"></div>
                <div class="col"><label>Public Key</label><input type="text" id="publicKey"></div>
                <div class="col"><label>Private Key</label><input type="password" id="privateKey"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-top:0">âš™ï¸ NastavenÃ­ vÃ½poÄtu Dipu</h3>
        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Zde urÄÃ­te, z jakÃ©ho obdobÃ­ mÃ¡ bot poÄÃ­tat "prÅ¯mÄ›rnou cenu", od kterÃ© pak odeÄÃ­tÃ¡ vaÅ¡i slevu.</p>
        
        <div class="row" style="align-items: flex-start;">
            <div class="col" style="flex: 0 0 250px;">
                <label>ReÅ¾im prÅ¯mÄ›rovÃ¡nÃ­</label>
                <div class="radio-group">
                    <div class="radio-item" onclick="document.getElementById('modeLast').click()">
                        <input type="radio" name="avgMode" id="modeLast" value="last_buy" onchange="toggleSettingsUI()">
                        <span>Od poslednÃ­ho nÃ¡kupu</span>
                    </div>
                    <div class="radio-item" onclick="document.getElementById('modeFixed').click()">
                        <input type="radio" name="avgMode" id="modeFixed" value="fixed" onchange="toggleSettingsUI()">
                        <span>VlastnÃ­ interval</span>
                    </div>
                </div>
            </div>

            <div class="col">
                <label>DÃ©lka intervalu</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="fixedValue" min="1" placeholder="3" style="flex: 1;">
                    <select id="fixedUnit" style="flex: 1;">
                        <option value="hours">Hodin</option>
                        <option value="days" selected>DnÃ­</option>
                        <option value="weeks">TÃ½dnÅ¯</option>
                        <option value="months">MÄ›sÃ­cÅ¯</option>
                    </select>
                </div>
                <div class="form-text" id="helpText">...</div>
            </div>
        </div>
    </div>

    <h3 style="margin: 20px 0;">ğŸš€ AktivnÃ­ Strategie</h3>
    <div class="strategies-grid" id="strategies-container"></div>

    <div class="card mt-3">
        <h3 style="margin-top:0">ğŸ“ˆ RÅ¯st Portfolia</h3>
        <div style="height: 300px;"><canvas id="portfolioChart"></canvas></div>
    </div>
</div>

<div class="actions-bar">
    <button class="btn" style="background:var(--warning)" onclick="restartBot()">ğŸ”„ Restartovat</button>
    <button class="btn" style="background:var(--success)" onclick="saveConfig()">ğŸ’¾ UloÅ¾it VÅ¡e & Spustit</button>
</div>

<script>
    let strategies = [];
    const COIN_COLORS = { 'BTC': '#f7931a', 'ETH': '#627eea', 'SOL': '#9945FF', 'LTC': '#345d9d' };
    const SUPPORTED_COINS = [{code:'BTC', name:'Bitcoin'}, {code:'ETH', name:'Ethereum'}, {code:'SOL', name:'Solana'}];
    const WEEK_DAYS = [{v:1, n:'PondÄ›lÃ­'}, {v:2, n:'ÃšterÃ½'}, {v:3, n:'StÅ™eda'}, {v:4, n:'ÄŒtvrtek'}, {v:5, n:'PÃ¡tek'}, {v:6, n:'Sobota'}, {v:0, n:'NedÄ›le'}];

    async function loadData() {
        const res = await fetch('/api/config');
        const data = await res.json();
        if(data.api) {
            document.getElementById('clientId').value = data.api.clientId || '';
            document.getElementById('publicKey').value = data.api.publicKey || '';
            document.getElementById('privateKey').value = data.api.privateKey || '';
        }
        
        // NaÄtenÃ­ nastavenÃ­ prÅ¯mÄ›rovÃ¡nÃ­
        const set = data.settings || {};
        if (set.averageCalculation === 'last_buy') {
            document.getElementById('modeLast').checked = true;
        } else {
            document.getElementById('modeFixed').checked = true;
        }
        
        document.getElementById('fixedValue').value = set.fixedValue || 3;
        document.getElementById('fixedUnit').value = set.fixedUnit || 'days';
        
        toggleSettingsUI(); // NastavÃ­ enabled/disabled stav a texty
        
        strategies = data.strategies || [];
        renderStrategies();
    }

    function toggleSettingsUI() {
        const isLastBuy = document.getElementById('modeLast').checked;
        const inputVal = document.getElementById('fixedValue');
        const inputUnit = document.getElementById('fixedUnit');
        const helpText = document.getElementById('helpText');

        if (isLastBuy) {
            inputVal.disabled = true;
            inputUnit.disabled = true;
            helpText.innerText = "Bot zjistÃ­ datum tvÃ©ho poslednÃ­ho nÃ¡kupu danÃ© mince a spoÄÃ­tÃ¡ prÅ¯mÄ›rnou cenu pÅ™esnÄ› od tÃ© chvÃ­le do teÄ.";
        } else {
            inputVal.disabled = false;
            inputUnit.disabled = false;
            helpText.innerText = "Bot bude vÅ¾dy poÄÃ­tat prÅ¯mÄ›rnou cenu za poslednÃ­ch X hodin/dnÃ­/tÃ½dnÅ¯, bez ohledu na to, kdy jsi naposledy nakoupil.";
        }
    }

    function renderStrategies() {
        const container = document.getElementById('strategies-container');
        container.innerHTML = '';
        strategies.forEach((strat, index) => {
            const [coin, fiat] = strat.pair.split('_');
            const card = document.createElement('div');
            card.className = 'strategy-card';
            card.style.setProperty('--strat-color', COIN_COLORS[coin] || '#888');
            
            let timeFields = '';
            if(strat.frequency === 'daily') {
                timeFields = `<label>Hodina (0-23)</label><input type="number" value="${strat.runHour}" onchange="strategies[${index}].runHour=Number(this.value)">`;
            } else if(strat.frequency === 'weekly') {
                timeFields = `<div class="row"><div class="col"><label>Den</label><select onchange="strategies[${index}].runDay=Number(this.value)">${WEEK_DAYS.map(d=>`<option value="${d.v}" ${strat.runDay===d.v?'selected':''}>${d.n}</option>`).join('')}</select></div><div class="col"><label>Hodina</label><input type="number" value="${strat.runHour}" onchange="strategies[${index}].runHour=Number(this.value)"></div></div>`;
            } else {
                timeFields = `<div class="row"><div class="col"><label>Den v mÄ›sÃ­ci</label><input type="number" value="${strat.runDay}" onchange="strategies[${index}].runDay=Number(this.value)"></div><div class="col"><label>Hodina</label><input type="number" value="${strat.runHour}" onchange="strategies[${index}].runHour=Number(this.value)"></div></div>`;
            }

            card.innerHTML = `
                <button class="btn-delete" onclick="removeStrategy(${index})">ğŸ—‘</button>
                <div style="margin-bottom:20px"><strong style="color:var(--strat-color); font-size:1.4rem; font-weight:800;">${coin} nÃ¡kup</strong></div>
                <div class="row"><div class="col"><label>Koupit</label><select onchange="updatePair(${index},0,this.value)">${SUPPORTED_COINS.map(c=>`<option value="${c.code}" ${coin===c.code?'selected':''}>${c.name}</option>`).join('')}</select></div><div class="col"><label>MÄ›na</label><select onchange="updatePair(${index},1,this.value)"><option value="CZK" ${fiat==='CZK'?'selected':''}>CZK</option><option value="EUR" ${fiat==='EUR'?'selected':''}>EUR</option></select></div></div>
                <div class="mt-3"><label>ÄŒÃ¡stka (${fiat})</label><input type="number" value="${strat.amount}" onchange="strategies[${index}].amount=Number(this.value)"></div>
                <div class="mt-3"><label>Dip (%)</label><input type="number" step="0.1" value="${(strat.dipPercentage*100).toFixed(1)}" onchange="strategies[${index}].dipPercentage=Number(this.value)/100"></div>
                <div class="mt-3"><label>Frekvence</label><select onchange="strategies[${index}].frequency=this.value; renderStrategies();"><option value="daily" ${strat.frequency==='daily'?'selected':''}>DennÄ›</option><option value="weekly" ${strat.frequency==='weekly'?'selected':''}>TÃ½dnÄ›</option><option value="monthly" ${strat.frequency==='monthly'?'selected':''}>MÄ›sÃ­ÄnÄ›</option></select></div>
                <div class="mt-3">${timeFields}</div>
                <div class="form-text">Pozn: ÄŒas 14 = 14:00. Bot nakoupÃ­ v tuto hodinu a bude Äekat na Dip tÃ©mÄ›Å™ 24h.</div>
            `;
            container.appendChild(card);
        });
    }

    function updatePair(idx, pos, val) {
        let p = strategies[idx].pair.split('_');
        p[pos] = val; strategies[idx].pair = p.join('_'); renderStrategies();
    }
    function removeStrategy(idx) { if(confirm('Smazat?')) { strategies.splice(idx,1); renderStrategies(); } }
    async function saveConfig() {
        const api = { clientId: document.getElementById('clientId').value, publicKey: document.getElementById('publicKey').value, privateKey: document.getElementById('privateKey').value };
        
        // NaÄtenÃ­ novÃ©ho nastavenÃ­
        const averageCalculation = document.getElementById('modeLast').checked ? 'last_buy' : 'fixed';
        const fixedValue = Number(document.getElementById('fixedValue').value) || 3;
        const fixedUnit = document.getElementById('fixedUnit').value;

        await fetch('/api/config', { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({
                api, 
                strategies, 
                settings: { averageCalculation, fixedValue, fixedUnit }
            }) 
        });
        alert('UloÅ¾eno!');
    }
    loadData();
</script>
</body>
</html>